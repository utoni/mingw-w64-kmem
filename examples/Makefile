ifndef DPP_ROOT
$(error DPP_ROOT is undefined)
endif

ifndef KMEM_ROOT
$(error KMEM_ROOT is undefined)
endif

include $(DPP_ROOT)/Makefile.inc
include $(KMEM_ROOT)/Makefile.inc

DRIVER_NAME = driver-kmem
DRIVER_OBJECTS = driver-kmem.o $(LIBKMEM_EXP)
DRIVER_TARGET = $(DRIVER_NAME).sys
CFLAGS_driver-kmem.o = -DENABLE_EXPERIMENTAL=1

UMODE_IPC_NAME = usermode-ipc
UMODE_IPC_OBJECTS = $(UMODE_IPC_NAME).o $(LIBKMEM_USER)
UMODE_IPC_TARGET = $(UMODE_IPC_NAME).exe
CFLAGS_usermode-ipc.o = -DBUILD_USERMODE=1

TARKOV_NAME = tfk
TARKOV_OBJECTS = tarkov.o $(LIBKMEM)
TARKOV_TARGET = $(TARKOV_NAME).sys

HUNT_NAME = ht
HUNT_OBJECTS = hunt.o $(LIBKMEM)
HUNT_TARGET = $(HUNT_NAME).sys

HUNT1896_NAME = ht2
HUNT1896_OBJECTS = hunt2.o $(LIBKMEM)
HUNT1896_TARGET = $(HUNT1896_NAME).sys

HUNT1896_DBG_NAME = ht2_dbg
HUNT1896_DBG_OBJECTS = hunt2_dbg.o $(LIBKMEM)
HUNT1896_DBG_TARGET = $(HUNT1896_DBG_NAME).sys
CFLAGS_hunt2_dbg.o = -DHUNT2_DEBUG=1

BF4_NAME = bf4
BF4_OBJECTS = bf4.o $(LIBKMEM)
BF4_TARGET = $(BF4_NAME).sys

all: $(DRIVER_TARGET) $(UMODE_IPC_TARGET) \
	$(TARKOV_TARGET) $(HUNT_TARGET) $(HUNT1896_TARGET) $(HUNT1896_DBG_TARGET) $(BF4_TARGET)

hunt2_dbg.o: hunt2.cpp
	$(call BUILD_CPP_OBJECT,$<,$@)

%.o: %.cpp
	$(call BUILD_CPP_OBJECT,$<,$@)

$(DRIVER_TARGET): $(DRIVER_OBJECTS)
	$(call LINK_CPP_KERNEL_TARGET,$(DRIVER_OBJECTS),$@)

$(UMODE_IPC_TARGET): $(UMODE_IPC_OBJECTS)
	$(call LINK_CPP_USER_TARGET,$(UMODE_IPC_OBJECTS),$@)

$(TARKOV_TARGET): $(TARKOV_OBJECTS)
	$(call LINK_CPP_KERNEL_TARGET,$(TARKOV_OBJECTS),$@)

$(HUNT_TARGET): $(HUNT_OBJECTS)
	$(call LINK_CPP_KERNEL_TARGET,$(HUNT_OBJECTS),$@)

$(HUNT1896_TARGET): $(HUNT1896_OBJECTS)
	$(call LINK_CPP_KERNEL_TARGET,$(HUNT1896_OBJECTS),$@)

$(HUNT1896_DBG_TARGET): $(HUNT1896_DBG_OBJECTS)
	$(call LINK_CPP_KERNEL_TARGET,$(HUNT1896_DBG_OBJECTS),$@)

$(BF4_TARGET): $(BF4_OBJECTS)
	$(call LINK_CPP_KERNEL_TARGET,$(BF4_OBJECTS),$@)

install: $(DRIVER_TARGET) $(UMODE_IPC_TARGET) $(TARKOV_TARGET) $(HUNT_TARGET) $(HUNT1896_TARGET) $(HUNT1896_DBG_TARGET) $(BF4_TARGET)
	$(call INSTALL_EXEC_SIGN,$(DRIVER_TARGET))
	$(CP) $(DRIVER_NAME).bat $(DESTDIR)
	$(CP) $(UMODE_IPC_TARGET) $(DESTDIR)
	$(call INSTALL_EXEC_SIGN,$(TARKOV_TARGET))
	$(CP) $(TARKOV_NAME).bat $(DESTDIR)
	$(call INSTALL_EXEC_SIGN,$(HUNT_TARGET))
	$(CP) $(HUNT_NAME).bat $(DESTDIR)
	$(call INSTALL_EXEC_SIGN,$(HUNT1896_TARGET))
	$(CP) $(HUNT1896_DBG_NAME).bat $(DESTDIR)
	$(call INSTALL_EXEC_SIGN,$(HUNT1896_DBG_TARGET))
	$(CP) $(HUNT1896_NAME).bat $(DESTDIR)
	$(call INSTALL_EXEC_SIGN,$(BF4_TARGET))
	$(CP) $(BF4_NAME).bat $(DESTDIR)

clean:
	rm -f driver-kmem.o usermode-ipc.o tfk.o ht.o ht2.o ht2_dbg.o bf4.o
	rm -f $(DRIVER_TARGET) $(DRIVER_TARGET).map
	rm -f $(UMODE_IPC_TARGET)
	rm -f $(TARKOV_TARGET) $(TARKOV_TARGET).map
	rm -f $(HUNT_TARGET) $(HUNT_TARGET).map
	rm -f $(HUNT1896_TARGET) $(HUNT1896_TARGET).map
	rm -f $(HUNT1896_DBG_TARGET) $(HUNT1896_DBG_TARGET).map
	rm -f $(BF4_TARGET) $(BF4_TARGET).map

.NOTPARALLEL: all install clean
.PHONY: all install clean
